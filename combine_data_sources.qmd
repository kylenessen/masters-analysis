---
title: "Combine Data Sources"
format: html
---

```{r setup}
library(tidyverse)
library(here)
```

## Load Data

```{r load-data}
# Load butterfly abundance data
butterfly_abundance <- read_csv(here("data", "butterfly_abundance_complete_days.csv"))

# Load deployments data
deployments <- read_csv(here("data", "deployments.csv"))

# Load temperature data
temperature_data <- read_csv(here("data", "temperature_data_2023.csv"))

# Load wind data
wind_data <- read_csv(here("data", "wind_all.csv"))
```

## Data Summaries

### Butterfly Abundance
```{r butterfly-summary}
glimpse(butterfly_abundance)
summary(butterfly_abundance)
```

### Deployments
```{r deployments-summary}
glimpse(deployments)
summary(deployments)
```

### Temperature Data
```{r temperature-summary}
glimpse(temperature_data)
summary(temperature_data)
```

### Wind Data
```{r wind-summary}
glimpse(wind_data)
summary(wind_data)
```

## Combine Data

### Join Butterfly Abundance with Temperature

```{r prepare-temperature}
# Check for matching filenames
n_matches <- butterfly_abundance %>%
  inner_join(temperature_data, by = c("image_filename" = "filename")) %>%
  nrow()

cat("Number of butterfly records with matching temperature data:", n_matches, "out of", nrow(butterfly_abundance), "\n")
```

```{r combine-data}
# Create combined analysis dataframe with butterfly_abundance as base
analysis_df <- butterfly_abundance %>%
  left_join(
    temperature_data %>%
      select(filename, temperature, confidence),
    by = c("image_filename" = "filename")
  )

# Check for any missing temperature values
missing_temp <- analysis_df %>%
  filter(is.na(temperature)) %>%
  nrow()

cat("Records missing temperature data:", missing_temp, "\n")

# Summary of combined data
glimpse(analysis_df)
summary(analysis_df)
```

### Visualize Temperature-Butterfly Relationship

```{r temp-butterfly-viz}
# Quick visualization of temperature vs butterfly abundance
ggplot(analysis_df, aes(x = temperature, y = total_butterflies)) +
  geom_point(alpha = 0.3) +
  geom_smooth(method = "loess") +
  labs(
    title = "Butterfly Abundance vs Temperature",
    x = "Temperature (Â°C)",
    y = "Total Butterflies"
  ) +
  theme_minimal()
```