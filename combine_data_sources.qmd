---
title: "Combine Data Sources"
format: html
---

```{r setup}
library(tidyverse)
library(here)
```

## Load Data

```{r load-data}
# Load butterfly abundance data
butterfly_abundance <- read_csv(here("data", "butterfly_abundance_complete_days.csv"))

# Load deployments data
deployments <- read_csv(here("data", "deployments.csv"))

# Load temperature data
temperature_data <- read_csv(here("data", "temperature_data_2023.csv"))

# Load wind data
wind_data <- read_csv(here("data", "wind_all.csv"))
```

## Data Summaries

### Butterfly Abundance
```{r butterfly-summary}
glimpse(butterfly_abundance)
summary(butterfly_abundance)
```

### Deployments
```{r deployments-summary}
glimpse(deployments)
summary(deployments)
```

### Temperature Data
```{r temperature-summary}
glimpse(temperature_data)
summary(temperature_data)
```

### Wind Data
```{r wind-summary}
glimpse(wind_data)
summary(wind_data)
```

## Combine Data

### Join Butterfly Abundance with Temperature

```{r prepare-temperature}
# Check for matching filenames
n_matches <- butterfly_abundance %>%
  inner_join(temperature_data, by = c("image_filename" = "filename")) %>%
  nrow()

cat("Number of butterfly records with matching temperature data:", n_matches, "out of", nrow(butterfly_abundance), "\n")
```

```{r combine-data}
# Create combined analysis dataframe with butterfly_abundance as base
analysis_df <- butterfly_abundance %>%
  left_join(
    temperature_data %>%
      select(filename, temperature),
    by = c("image_filename" = "filename")
  ) %>%
  left_join(
    deployments %>%
      select(deployment_id, wind_meter_name, 
             horizontal_dist_to_cluster_m, height_m, Observer, view_id),
    by = "deployment_id"
  )

# Check for any missing temperature values
missing_temp <- analysis_df %>%
  filter(is.na(temperature)) %>%
  nrow()

cat("Records missing temperature data:", missing_temp, "\n")

# Check deployment metadata join
n_deployments <- analysis_df %>%
  distinct(deployment_id) %>%
  nrow()

cat("Number of unique deployments in analysis_df:", n_deployments, "\n")

# Summary of combined data
glimpse(analysis_df)
summary(analysis_df)
```

